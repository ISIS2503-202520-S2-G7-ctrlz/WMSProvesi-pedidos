#!/bin/bash
sudo -i -u ubuntu bash << 'EOF'

# === Variables ===
DB_HOST="172.31.27.105"   # ⚠️ Reemplaza con la IP privada real de tu base de datos

# === Instalación de dependencias ===
sudo apt update -y
sudo apt install -y git python3-pip

# === Clonar el repositorio ===
cd /home/ubuntu
git clone https://github.com/ISIS2503-202520-S2-G7-ctrlz/WMSProvesi-pedidos.git

# === Instalar dependencias ===
cd WMSProvesi-pedidos
pip3 install -r requirements.txt --break-system-packages

# === Entrar al directorio del proyecto principal ===
cd WMSProvesi-pedidos

# === Confirmar reemplazo del HOST ===
echo "Configurando la base de datos con host ${DB_HOST}..."
sed -i "s/'HOST': 'localhost'/'HOST': '${DB_HOST}'/" settings.py

# Verificar cambio
grep "'HOST'" settings.py

cd ..

# === Ejecutar migraciones ===
python3 manage.py makemigrations
python3 manage.py migrate

# === Levantar servidor Django ===
nohup python3 manage.py runserver 0.0.0.0:8080 > /home/ubuntu/django.log 2>&1 &

EOF
